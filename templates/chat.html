{% extends "base.html" %}
{% block title %}Chat v·ªõi Hidemium AI ‚Äì 2025{% endblock %}
{% block content %}

<div class="chat-layout">

    <!-- LEFT: SESSION LIST -->
    <aside class="sessions-panel">

        <!-- TOP MENU -->
        <div class="sidebar-menu">

            <button class="menu-item primary" onclick="startNewChat()">
                <span class="icon">‚úèÔ∏è</span>
                <span class="label">ƒêo·∫°n chat m·ªõi</span>
                <span class="shortcut">Ctrl + Shift + O</span>
            </button>

            <button class="menu-item" onclick="toggleSearch()">
                <span class="icon">üîç</span>
                <span class="label">T√¨m ki·∫øm ƒëo·∫°n chat</span>
                <span class="shortcut">Ctrl + K</span>
            </button>

            <input
                type="text"
                id="sessionSearch"
                class="session-search"
                placeholder="T√¨m ki·∫øm ƒëo·∫°n chat..."
                oninput="filterSessions(this.value)"
                hidden
            />

        </div>

        <!-- SESSION LIST -->
        <ul class="sessions-list" id="sessionsList"></ul>
    </aside>

    <!-- RIGHT: CHAT -->
    <div class="chat-wrapper">
        <div class="bg-gradient"></div>

        <div class="chat-container">

            <!-- Header -->
            <header class="chat-header">
                <div class="header-content">
                    <div class="ai-info">
                        <div class="ai-badge"><span>AI</span></div>
                        <div class="ai-text">
                            <h2>Hidemium AI</h2>
                            <div class="status">
                                <span class="status-dot"></span>
                                <span>ƒêang online</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Messages Area -->
            <main class="messages-container" id="messagesContainer">
                <div class="messages" id="messages"></div>

                <div class="thinking-indicator" id="thinkingIndicator">
                    <div class="thinking-dots">
                        <span></span><span></span><span></span>
                    </div>
                    <span>ƒêang suy nghƒ©...</span>
                </div>

                <button id="scrollToBottom"
                        class="scroll-btn"
                        onclick="scrollToBottom()"
                        aria-label="Cu·ªôn xu·ªëng">
                    <svg viewBox="0 0 24 24"
                         width="20"
                         height="20"
                         fill="none"
                         stroke="currentColor"
                         stroke-width="2.5">
                        <path d="M12 5v14m-7-7 7 7 7-7"/>
                    </svg>
                </button>
            </main>

            <!-- Input Area -->
            <footer class="input-section">
                <div class="input-container">

                    <form id="chatForm">
                        <div class="input-box">
                            <textarea
                                id="userInput"
                                rows="1"
                                placeholder="H·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨..."
                                autocomplete="off"
                                autofocus
                                required
                            ></textarea>

                            <div class="input-tools">
                                <button type="submit"
                                        id="sendBtn"
                                        class="send-btn"
                                        aria-label="G·ª≠i">
                                    <svg viewBox="0 0 24 24"
                                         width="22"
                                         height="22"
                                         fill="currentColor">
                                        <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="input-meta">
                            <small>Enter ‚Üµ g·ª≠i ‚Ä¢ Shift + Enter xu·ªëng d√≤ng</small>
                            <small id="charCount">0/4000</small>
                        </div>
                    </form>

                </div>
            </footer>

        </div>
    </div>

</div>

<script>
// =========================
// SESSION STORAGE
// =========================

let currentSessionId = localStorage.getItem("hidemium_session_id");
let sessions = JSON.parse(localStorage.getItem("hidemium_sessions") || "[]");
let sessionTitles = JSON.parse(localStorage.getItem("hidemium_session_titles") || "{}");
let pinnedSessions = JSON.parse(localStorage.getItem("hidemium_pinned_sessions") || "[]");

if (!currentSessionId) {
    currentSessionId = "sess_" + crypto.randomUUID();
    localStorage.setItem("hidemium_session_id", currentSessionId);
}

// =========================
// UI HELPERS
// =========================

function addMessage(role, content) {
    const messages = document.getElementById("messages");
    const bubble = document.createElement("div");
    bubble.className = `message ${role}`;

    bubble.innerHTML = `
        <div class="bubble">
            <div class="content">${String(content).replace(/\n/g, "<br>")}</div>
        </div>
    `;

    messages.appendChild(bubble);
    scrollToBottom();
}

function showThinking() {
    document.getElementById("thinkingIndicator").style.display = "flex";
    scrollToBottom();
}

function hideThinking() {
    document.getElementById("thinkingIndicator").style.display = "none";
}

function scrollToBottom() {
    const container = document.getElementById("messagesContainer");
    container.scrollTo({ top: container.scrollHeight, behavior: "smooth" });
}

// =========================
// SESSION LIST UI
// =========================

function renderSessions() {
    const ul = document.getElementById("sessionsList");
    ul.innerHTML = "";

    const ordered = [
        ...pinnedSessions.filter(id => sessions.includes(id)),
        ...sessions.filter(id => !pinnedSessions.includes(id))
    ];

    ordered.forEach(sid => {
        if (!sessionTitles[sid]) return;

        const li = document.createElement("li");
        const isActive = sid === currentSessionId;
        const isPinned = pinnedSessions.includes(sid);

        li.innerHTML = `
            <div class="session-row ${isActive ? "active" : ""}">
                <span class="title">${sessionTitles[sid]}</span>

                <button class="session-more"
                        onclick="toggleSessionMenu(event, '${sid}')">
                    ‚ãØ
                </button>

                <div class="session-menu" id="menu-${sid}" hidden>
                    <button onclick="onPinClick(event, '${sid}')">
                        ${isPinned ? "‚≠ê B·ªè ghim" : "‚≠ê Ghim"}
                    </button>

                    <button onclick="onRenameClick(event, '${sid}')">
                        ‚úèÔ∏è ƒê·ªïi t√™n
                    </button>

                    <button class="danger"
                            onclick="onDeleteClick(event, '${sid}')">
                        üóë Xo√°
                    </button>
                </div>
            </div>
        `;

        const row = li.querySelector(".session-row");

        row.onclick = e => {
            if (
                e.target.closest(".session-more") ||
                e.target.closest(".session-menu")
            ) return;

            loadSession(sid);
        };

        ul.appendChild(li);
    });
}

async function loadSession(sid) {
    if (sid === currentSessionId) return;

    currentSessionId = sid;
    localStorage.setItem("hidemium_session_id", currentSessionId);

    const messagesEl = document.getElementById("messages");
    messagesEl.innerHTML = "";

    try {
        const res = await fetch(`/session/${sid}`);
        const data = await res.json();

        if (data.history && data.history.length) {
            data.history.forEach(m => {
                addMessage(m.role, m.content);
            });

            if (!sessionTitles[sid]) {
                const firstUserMsg = data.history.find(m => m.role === "user");
                if (firstUserMsg) {
                    sessionTitles[sid] =
                        firstUserMsg.content.slice(0, 60);

                    localStorage.setItem(
                        "hidemium_session_titles",
                        JSON.stringify(sessionTitles)
                    );
                }
            }

        } else {
            addWelcomeMessage();
        }

    } catch (err) {
        console.error("Load session error:", err);
        addWelcomeMessage();
    }

    renderSessions();
}

// =========================
// SESSION ACTIONS
// =========================

function startNewChat() {
    currentSessionId = "sess_" + crypto.randomUUID();
    localStorage.setItem("hidemium_session_id", currentSessionId);
    document.getElementById("messages").innerHTML = "";
    addWelcomeMessage();
}

function deleteSession(sid) {
    sessions = sessions.filter(id => id !== sid);
    pinnedSessions = pinnedSessions.filter(id => id !== sid);

    delete sessionTitles[sid];

    localStorage.setItem("hidemium_sessions", JSON.stringify(sessions));
    localStorage.setItem("hidemium_session_titles", JSON.stringify(sessionTitles));
    localStorage.setItem("hidemium_pinned_sessions", JSON.stringify(pinnedSessions));

    if (currentSessionId === sid) startNewChat();

    renderSessions();
}

function pinSession(sid) {
    if (pinnedSessions.includes(sid)) {
        pinnedSessions = pinnedSessions.filter(id => id !== sid);
    } else {
        pinnedSessions.unshift(sid);
    }

    localStorage.setItem("hidemium_pinned_sessions", JSON.stringify(pinnedSessions));
    renderSessions();
}

function renameSession(sid) {
    const current = sessionTitles[sid];
    const newTitle = prompt("ƒê·ªïi t√™n ƒëo·∫°n chat:", current);

    if (newTitle && newTitle.trim()) {
        sessionTitles[sid] = newTitle.trim();
        localStorage.setItem("hidemium_session_titles", JSON.stringify(sessionTitles));
        renderSessions();
    }
}

// =========================
// MENU EVENT WRAPPERS
// =========================

function toggleSessionMenu(e, sid) {
    e.stopPropagation();

    document.querySelectorAll(".session-menu").forEach(m => {
        if (m.id !== `menu-${sid}`) m.hidden = true;
    });

    const menu = document.getElementById(`menu-${sid}`);
    menu.hidden = !menu.hidden;
}

function onPinClick(e, sid) {
    e.stopPropagation();
    pinSession(sid);
    closeAllMenus();
}

function onRenameClick(e, sid) {
    e.stopPropagation();
    renameSession(sid);
    closeAllMenus();
}

function onDeleteClick(e, sid) {
    e.stopPropagation();
    if (confirm("Xo√° ƒëo·∫°n chat n√†y?")) {
        deleteSession(sid);
    }
    closeAllMenus();
}

function closeAllMenus() {
    document.querySelectorAll(".session-menu").forEach(m => {
        m.hidden = true;
    });
}

// Click ra ngo√†i ‚Üí ƒë√≥ng menu
document.addEventListener("click", closeAllMenus);

// =========================
// WELCOME
// =========================

function addWelcomeMessage() {
    const container = document.getElementById("messages");

    // Ch·ªâ render n·∫øu ch∆∞a c√≥ message n√†o
    if (container.children.length === 0) {
        container.innerHTML = `
            <div class="welcome">
                <div class="welcome-avatar">AI</div>

                <h3>Xin ch√†o! üëã</h3>
                <p>
                    T√¥i l√† <strong>Hidemium AI</strong> ‚Äî tr·ª£ l√Ω th√¥ng minh lu√¥n s·∫µn s√†ng h·ªó tr·ª£ b·∫°n.<br>
                    B·∫°n mu·ªën b·∫Øt ƒë·∫ßu t·ª´ ƒë√¢u? üòä
                </p>

                <div class="quick-buttons">
                    <button onclick="askQuick('Gi·ªõi thi·ªáu v·ªÅ c√¥ng ty Hachitech Solution')">
                        üí¨ Gi·ªõi thi·ªáu v·ªÅ c√¥ng ty
                    </button>
                    <button onclick="askQuick('API c·ªßa Hidemium l√† g√¨?')">
                        üîë H∆∞·ªõng d·∫´n l·∫•y API
                    </button>

                    <button onclick="askQuick('C√°ch import cookie profile v√†o Hidemium')">
                        üç™ Import cookie profile
                    </button>

                    <button onclick="askQuick('T√¥i g·∫∑p l·ªói khi t·∫°o profile, x·ª≠ l√Ω th·∫ø n√†o?')">
                        üõ†Ô∏è X·ª≠ l√Ω l·ªói th∆∞·ªùng g·∫∑p
                    </button>
                </div>
            </div>
        `;
    }
}


// =========================
// INPUT + SEND
// =========================

const input = document.getElementById("userInput");

input.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (input.value.trim()) {
            document.getElementById("chatForm")
                .dispatchEvent(new Event("submit"));
        }
    }
});

document.getElementById("chatForm").onsubmit = async e => {
    e.preventDefault();

    const message = input.value.trim();
    if (!message) return;

    addMessage("user", message);

    if (!sessions.includes(currentSessionId)) {
        sessions.unshift(currentSessionId);
        localStorage.setItem("hidemium_sessions", JSON.stringify(sessions));
    }

    if (!sessionTitles[currentSessionId]) {
        sessionTitles[currentSessionId] = message.slice(0, 60);
        localStorage.setItem(
            "hidemium_session_titles",
            JSON.stringify(sessionTitles)
        );
    }

    renderSessions();
    input.value = "";
    showThinking();

    try {
        const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({
                message,
                session_id: currentSessionId
            })
        });

        const data = await res.json();
        hideThinking();
        addMessage("bot", data.response || "Kh√¥ng c√≥ ph·∫£n h·ªìi.");

    } catch (err) {
        hideThinking();
        addMessage("bot", "L·ªói k·∫øt n·ªëi.");
    }
};

// =========================
// SEARCH + SHORTCUTS
// =========================

function toggleSearch() {
    const input = document.getElementById("sessionSearch");
    input.hidden = !input.hidden;
    if (!input.hidden) input.focus();
    else filterSessions("");
}

function filterSessions(query) {
    const q = query.toLowerCase();
    document.querySelectorAll(".session-row").forEach(el => {
        el.style.display =
            el.textContent.toLowerCase().includes(q)
                ? "flex"
                : "none";
    });
}

document.addEventListener("keydown", e => {
    if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "o") {
        e.preventDefault();
        startNewChat();
    }

    if (e.ctrlKey && e.key.toLowerCase() === "k") {
        e.preventDefault();
        toggleSearch();
    }
});
function askQuick(text) {
    const input = document.getElementById("userInput");

    input.value = text;
    input.focus();

    // Auto submit
    document.getElementById("chatForm")
        .dispatchEvent(new Event("submit"));
}

// =========================
// INIT
// =========================

document.addEventListener("DOMContentLoaded", () => {
    addWelcomeMessage();
    renderSessions();
});
</script>


{% endblock %}
