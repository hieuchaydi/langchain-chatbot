{% extends "base.html" %}
{% block title %}CSKH Live – Đang Online{% endblock %}

{% block content %}
<div class="cskh-container">
    <h1 class="cskh-title">
        CSKH ĐANG ONLINE – Có <span id="count">0</span> khách đang chờ hỗ trợ
    </h1>

    <div class="cskh-main">
        <!-- Danh sách khách đang chờ -->
        <div class="customer-list" id="customers">
            <!-- JS sẽ tự thêm khách vào đây -->
        </div>

        <!-- Khu vực chat với khách hiện tại -->
        <div class="chat-area">
            <div id="chat" class="chat-messages">
                <div class="no-chat">Chọn một khách để bắt đầu chat</div>
            </div>

            <div class="chat-input">
                <input type="text" id="msg" placeholder="Gõ tin nhắn trả lời khách..." autocomplete="off">
                <button onclick="send()">Gửi</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentSession = null;
const ws = new WebSocket(`ws://${location.host}/ws-cskh`);

ws.onmessage = function(e) {
    const d = JSON.parse(e.data);
    if (d.type === "new_customer") {
        addCustomer(d.session_id, d.message);
    } else if (d.type === "message" && d.session_id === currentSession) {
        addMessage(d.message, "customer");
    } else if (d.type === "count") {
        document.getElementById("count").innerText = d.count;
    }
};

function addCustomer(session_id, firstMsg) {
    const div = document.createElement("div");
    div.className = "customer-item";
    div.dataset.session = session_id;
    div.innerHTML = `
        <strong>Khách ${session_id.slice(-6)}</strong>
        <small>${firstMsg.substring(0, 50)}...</small>
    `;
    div.onclick = () => {
        document.querySelectorAll(".customer-item").forEach(c => c.classList.remove("active"));
        div.classList.add("active");
        currentSession = session_id;
        document.getElementById("chat").innerHTML = `<div class="msg customer">${firstMsg}</div>`;
    };
    document.getElementById("customers").prepend(div);
    // Tự động chọn khách đầu tiên nếu chưa có ai
    if (!currentSession) div.click();
}

function addMessage(text, from) {
    const div = document.createElement("div");
    div.className = `msg ${from}`;
    div.textContent = text;
    document.getElementById("chat").appendChild(div);
    div.scrollIntoView({ behavior: "smooth" });
}

function send() {
    const input = document.getElementById("msg");
    if (!input.value.trim() || !currentSession) return;
    ws.send(JSON.stringify({
        type: "reply",
        session_id: currentSession,
        message: input.value
    }));
    addMessage(input.value, "cskh");
    input.value = "";
}

// Enter để gửi
document.getElementById("msg").addEventListener("keypress", e => {
    if (e.key === "Enter") send();
});
</script>

<style>
.cskh-container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }
.cskh-title {
    text-align: center; font-size: 2.5rem; color: #10b981;
    background: linear-gradient(90deg, #8b5cf6, #10b981);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 2rem;
}

.cskh-main {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 2rem;
    height: 80vh;
}

.customer-list {
    background: #1e293b; border-radius: 16px; padding: 1rem;
    overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.customer-item {
    background: #2d3748; padding: 1rem; margin-bottom: 1rem;
    border-radius: 12px; cursor: pointer; transition: all 0.3s;
    border-left: 4px solid transparent;
}
.customer-item:hover { background: #374151; transform: translateX(5px); }
.customer-item.active { border-left: 4px solid #10b981; background: #172436; }

.chat-area {
    background: #1e293b; border-radius: 16px; overflow: hidden;
    display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.chat-messages {
    flex: 1; padding: 1.5rem; overflow-y: auto;
    background: #0f172a;
}
.no-chat {
    text-align: center; color: #94a3b8; font-size: 1.2rem; margin-top: 100px;
}

.msg {
    max-width: 80%; margin: 10px 0; padding: 12px 16px;
    border-radius: 18px; line-height: 1.5; word-wrap: break-word;
}
.msg.customer {
    background: #3b82f6; color: white; margin-left: auto; border-bottom-right-radius: 4px;
}
.msg.cskh {
    background: #10b981; color: white; margin-right: auto; border-bottom-left-radius: 4px;
}

.chat-input {
    padding: 1rem; background: #1e293b; display: flex; gap: 10px; border-top: 1px solid #334155;
}
.chat-input input {
    flex: 1; padding: 14px; border: none; border-radius: 12px; background: #2d3748; color: white; font-size: 1rem;
}
.chat-input button {
    padding: 0 30px; background: #8b5cf6; color: white; border: none; border-radius: 12px;
    font-weight: bold; cursor: pointer; transition: 0.3s;
}
.chat-input button:hover { background: #7c3aed; transform: scale(1.05); }

@media (max-width: 768px) {
    .cskh-main { grid-template-columns: 1fr; }
    .customer-list { max-height: 200px; }
}
</style>
{% endblock %}